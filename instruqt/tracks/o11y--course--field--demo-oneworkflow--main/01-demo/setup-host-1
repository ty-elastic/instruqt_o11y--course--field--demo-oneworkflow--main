source /opt/workshops/elastic-retry.sh
export $(curl http://kubernetes-vm:9000/env | xargs)

export INSTRUQT_TRACK_SLUG=o11y--course--field--demo-oneworkflow--main
export REPO=us-central1-docker.pkg.dev/elastic-sa/tbekiares
export COURSE=o11y--course--field--demo-oneworkflow--main

/opt/workshops/clone-code.sh -r ty-elastic/instruqt_$INSTRUQT_TRACK_SLUG -d false

# ------------- OTEL

source /workspace/workshop/instruqt/scripts/elastic-otel.sh

# ------------- DEMO

cd /workspace/

git clone https://github.com/elastic/opentelemetry-demo.git
cd opentelemetry-demo
git checkout 2.1.5

kubectl create namespace "opentelemetry-demo"
helm upgrade --namespace "opentelemetry-demo" --install "my-otel-demo" "open-telemetry/opentelemetry-demo" --version 0.38.3 -f kubernetes/elastic-helm/demo.yml

# ------------- Load Balancer frontend-proxy

echo '
apiVersion: v1
kind: Service
metadata:
  name: frontend-proxy-lb
  namespace: opentelemetry-demo
spec:
  ports:
  - name: tcp-service
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    opentelemetry.io/name: frontend-proxy
  type: LoadBalancer' > /workspace/frontendproxy-lb.yaml

kubectl apply -f /workspace/frontendproxy-lb.yaml

# ------------- REMOTE

cd /workspace/workshop
export NAMESPACE=opentelemetry-demo
envsubst < remote/remote.yaml | kubectl apply -f -
cd /workspace/

# ------------- DASHBOARD

# kubectl delete namespace kubernetes-dashboard
# helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --namespace kubernetes-dashboard --create-namespace --set enableInsecureLogin=true --set protocolHttp=true

# echo '
# apiVersion: v1
# kind: Service
# metadata:
#   name: kubernetes-dashboard-ext
#   namespace: kubernetes-dashboard
# spec:
#   ports:
#   - name: kubernetes-dashboard
#     port: 34443
#     protocol: TCP
#     targetPort: 8443
#   selector:
#     app.kubernetes.io/component: app
#     app.kubernetes.io/instance: kubernetes-dashboard
#     app.kubernetes.io/name: kong
#   type: LoadBalancer' > /workspace/kubernetes-dashboard.yaml

# kubectl apply -f /workspace/kubernetes-dashboard.yaml